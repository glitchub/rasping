#!/usr/bin/python3 -u
#Note unbuffered output

import os, sys
from fnmatch import fnmatch
from time import sleep
from getopt import getopt
import subprocess

usage="""
Usage:

    autobridge [options] pattern [... pattern] bridge

Given one or more glob-style network interface name patterns and a bridge name,
create the bridge if necessary and add matching interfaces to it as they
appear.

Options are:

    -i ip.ad.re.ss/nm - specify static IP for the bridge

    -u interface - specify the upstream interface. The bridge will be forced
    down if this interface doesn't exist or doesn't have carrier.

    -x pattern - interfaces that match this patterm will always be ignored
    (except for the upstream interface). Can be used multiple times.

"""

# parse command line param
bridge = sys.argv[-1]
exclude={'lo', bridge}
include=set()
upstream=None
staticip=None

try:
    opts, args = getopt(sys.argv[1:],"u:x:i:")
    if len(args) < 2: raise Exception("Must specify at least one pattern and a bridge name.")
    include.update(args[:-1])
    bridge=args[-1]
    for opt, arg in opts:
        if opt == "-u":
            if upstream: raise Exception("Can't specify -u more than once.")
            upstream = arg
            include.add(upstream)
        if opt == "-i":
            if staticip: raise Exception("Can't specify -i more than once.")
            staticip = arg
        elif opt == "-x":
            exclude.add(arg)
except Exception as e:
    print (str(e), usage, file=sys.stderr)
    quit(1)

# return list of network interfaces
def interfaces(): return os.listdir('/sys/class/net')

# execute the 'ip' command with given command line
def ip(cmd): return subprocess.call(["ip"] + cmd.split())

isup=None # initial state unknown
def upbridge(up):
    global isup
    if up:
        if isup != True:
            print("Setting bridge up")
            if ip("link set dev %s up" % bridge): raise Exception("Could not set bridge up")
            isup = True
    else:
        if isup != False:
            print("Setting bridge down")
            if ip("link set dev %s down" % bridge): raise Exception("Could not set bridge down")
            isup = False

# return true if string s matches any listed glob
def matches(s, globs):
    for g in globs:
        if fnmatch(s, g):
            return True
    return False

if bridge in interfaces():
    if ip("link delete %s" % bridge):
        raise Exception("Could not remove existing %s" % bridge)

if ip("link add name %s type bridge" % bridge):
    raise Exception("Could not create %s" % bridge)

if staticip:
    print("Setting static IP %s" % staticip)
    ip("address flush dev %s" % bridge)
    if ip("address add %s dev %s" % (staticip, bridge)): raise Exception("Could not set IP address %s" % staticip)

if upstream:
    print("Using bridge %s with upstream %s" % (bridge, upstream))
    upbridge(False)
else:
    print("Using bridge %s" % bridge)
    upbridge(True)

print("Auto-bridging interfaces that match %s but not %s" % (str(include)[1:-1], str(exclude)[1:-1]))

ignore=[] # interfaces that failed to add properly

while True:
    current=interfaces()

    # unignore interfaces that no longer exist
    for i in set(ignore) - set(current): ignore.remove(i)

    # bridge goes down if upstream is unplugged
    if upstream:
        if upstream in current:
            try:
                with open("/sys/class/net/%s/carrier" % upstream) as f: carrier=bool(f.read())
            except:
                # Hmmm
                print("Could not read %s carrier!" % upstream)
                carrier = False
            # take bridge up if upstream has carrier
            upbridge(carrier)
        else:
            upbridge(False)

    # add interfaces to bridge if it's up
    if isup:
        for i in set(current) - set(os.listdir('/sys/class/net/%s/brif' % bridge)):
            if matches(i, include) and not matches(i, exclude) and not matches(i, ignore):
                print("Adding %s to %s" % (i, bridge))
                if ip("link set dev %s master %s up" % (i, bridge)):
                    print("Could not add %s" % i)
                    if i != upstream: ignore.append(i)

    # Repeat every second
    sleep(1)

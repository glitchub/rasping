#!/usr/bin/python3 -u
#Note unbuffered output

import os, sys, subprocess, netlink
from getopt import getopt

usage="""
Usage:

    autovlan [options] pattern [... pattern] vlanid

Given one or more glob-style network interface name patterns and a vlan id 1 to
4094, create a vlan for each matching interface.

Options are:

    -x pattern - interfaces that match this patterm will always be ignored. Can
    be used multiple times.
"""

reject={'lo', 'vlan.*'}
accept=set()

try:
    opts, args = getopt(sys.argv[1:],"x:")
    if len(args) < 2: raise Exception("Must specify at least one pattern and a vlan ID.")
    accept.update(args[:-1])
    vlanid=args[-1]
    assert 1 <= int(vlanid) <= 4094
    for opt, arg in opts:
        if opt == "-x": reject.add(arg)
except Exception as e:
    print (str(e), usage, file=sys.stderr)
    quit(1)

# execute the 'ip' command with given command line
def ip(cmd): return subprocess.call(["ip"] + cmd.split())

print("Applying vlan ID %s to interfaces that match %s but not %s" % (vlanid, str(accept)[1:-1], str(reject)[1:-1]))

# open the netlink object
nl=netlink.netlink()

vlan=set() # interfaces that we have vlan'd (or failed to)

# First find existing vlan.* devices so we don't try to create them again
for i in nl.dump(accept=["vlan.?*"]):
    print("Inheriting %s" % i.ifname)
    vlan.add(i.ifname[5:])

for i in nl.wait(accept=accept, reject=tuple(reject)):
    if not i.attached:
        # interface was unplugged
        if i.ifname in vlan:
            print("Forgetting", i.ifname)
            vlan.discard(i.ifname)
    elif i.ifname not in vlan:
        vname="vlan."+i.ifname
        print("Creating", vname)
        # make sure the interface is up first
        if ip("link set dev %s up" % i.ifname):
            print("Could not bring %s up" % i.ifname)
        elif ip("link add link %s name %s type vlan id %s" % (i.ifname, vname, vlanid)):
            print("Could not create %s" % vname)
        vlan.add(i.ifname)
